# 游戏结算系统实现说明

## 功能概述

实现了完整的游戏结算功能，当游戏中有两个玩家死亡时，会自动结束游戏并弹出转盘抽奖窗口。

## 实现的功能

### 1. 游戏结束检测 (`GameEndDetector.java`)
- 实时监控玩家存活状态
- 当存活玩家数量 ≤ 1 时触发游戏结束
- 支持游戏结束回调机制
- 可以获取获胜者信息

### 2. 抽奖界面 (`GameEndLotteryView.java`)
- 简洁美观的抽奖界面
- 大按钮设计，易于操作
- 点击"开始抽奖"按钮进行抽奖
- 抽奖动画效果（闪烁和缩放）
- 支持重新抽奖

### 3. 抽奖概率系统
- **种子种类概率：**
  - 胡萝卜种子：50%
  - 草莓种子：30%
  - 土豆种子：20%

- **数量概率：**
  - 1个种子：70%
  - 2个种子：25%
  - 3个种子：5%

### 4. 农场库存更新
- 自动将获得的种子添加到玩家的农场库存
- 与现有的农场系统完全集成
- 数据持久化保存

### 5. 游戏管理器集成 (`GameManager.java`)
- 集成游戏结束检测器
- 支持游戏结束回调注册
- 在游戏更新循环中自动检查结束条件

## 使用方法

### 启动游戏
```bash
# 运行测试脚本
test_game_end_system.bat

# 或直接运行
java -cp "target/classes;lib/*" com.stardewbombers.client.PlayerBombVisualTest
```

### 触发游戏结束
1. 在游戏中让两个玩家死亡（通过炸弹爆炸）
2. 游戏会自动检测到结束条件
3. 弹出抽奖窗口
4. 点击"开始抽奖"按钮进行抽奖
5. 获得种子奖励并自动更新到农场库存

## 技术实现细节

### 游戏结束检测流程
1. `GameManager.update()` 在每个游戏循环中调用
2. `GameEndDetector.checkGameEnd()` 检查存活玩家数量
3. 当条件满足时，触发注册的回调函数
4. 回调函数显示抽奖界面

### 抽奖算法
1. 根据概率分布随机选择种子类型
2. 根据概率分布随机选择种子数量
3. 更新农场库存
4. 显示抽奖结果

### 数据持久化
- 使用现有的 `SimpleFarmService` 系统
- 种子数据自动保存到文件
- 支持多玩家数据隔离

## 文件结构

```
src/main/java/com/stardewbombers/
├── client/
│   ├── GameEndLotteryView.java          # 抽奖界面
│   └── PlayerBombVisualTest.java        # 主游戏文件（已更新）
├── shared/game/
│   ├── GameEndDetector.java             # 游戏结束检测器
│   └── GameManager.java                 # 游戏管理器（已更新）
└── farm/
    └── SimpleFarmService.java           # 农场服务（已支持种子更新）
```

## 测试说明

1. 运行游戏后，使用WASD控制玩家1，方向键控制玩家2
2. 使用空格键和回车键放置炸弹
3. 让两个玩家被炸弹炸死
4. 观察游戏结束检测和抽奖功能
5. 检查农场库存是否正确更新

## 扩展可能性

- 可以添加更多种子类型
- 可以调整概率分布
- 可以添加特殊奖励机制
- 可以支持多人同时抽奖
- 可以添加抽奖历史记录

## 注意事项

- 抽奖界面是模态窗口，会阻塞其他操作
- 游戏结束后需要重新启动才能再次游戏
- 种子数据会自动保存，重启游戏后仍然有效
- 抽奖动画效果简单快速，用户体验更好
